<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="build gateway table" author="">
        <createTable tableName="gateway_accounts">
            <column name="gateway_account_id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="payment_provider" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="build tokens table" author="">
        <createTable tableName="tokens">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charge_id" type="bigserial">
                <constraints nullable="false"/>
            </column>
            <column name="secure_redirect_token" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="build charge table" author="">
        <createTable tableName="charges">
            <column name="charge_id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="amount" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="gateway_transaction_id" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="return_url" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="gateway_account_id" type="bigserial">
                <constraints foreignKeyName="fk__charges_gateway_accounts" referencedTableName="gateway_accounts"
                             referencedColumnNames="gateway_account_id" nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add description to charges table" author="">
        <addColumn tableName="charges">
            <column name="description" type="varchar(255)" defaultValue="">
                <constraints nullable="false" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add payment reference to charges table" author="">
        <addColumn tableName="charges">
            <column name="reference" type="varchar(255)" defaultValue="">
                <constraints nullable="false" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add credentials column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="credentials" type="json" defaultValue="{}">
                <constraints nullable="false" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="build charge_events table" author="">
        <createTable tableName="charge_events">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charge_id" type="bigserial">
                <constraints foreignKeyName="fk__charges_events" referencedTableName="charges"
                             referencedColumnNames="charge_id" nullable="false"/>
            </column>
            <column name="status" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="timestamp without timezone" defaultValueComputed="(now() at time zone 'utc')">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add created date to charges table" author="">
        <addColumn tableName="charges">
            <column name="created_date" type="timestamp without timezone"
                    defaultValueComputed="(now() at time zone 'utc')">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename 'gateway_accounts' primary key column" author="">
        <renameColumn columnDataType="bigserial"
                      oldColumnName="gateway_account_id"
                      newColumnName="id"
                      tableName="gateway_accounts"/>
    </changeSet>

    <changeSet id="rename 'charges' primary key column" author="">
        <renameColumn columnDataType="bigserial"
                      oldColumnName="charge_id"
                      newColumnName="id"
                      tableName="charges"/>
    </changeSet>

    <changeSet id="add version to charges table" author="">
        <addColumn tableName="charges">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add version to charge_events table" author="">
        <addColumn tableName="charge_events">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add version to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add version to tokens table" author="">
        <addColumn tableName="tokens">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add randomized external id to charges table" author="">
        <addColumn tableName="charges">
            <column name="external_id" type="char(26)">
                <constraints nullable="true" unique="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="migrate existing id data" author="">
        <sql>
            UPDATE charges SET external_id = id;
        </sql>
    </changeSet>

    <changeSet id="add NotNullConstraint to charges.external_id" author="">
        <addNotNullConstraint columnName="external_id"
                              tableName="charges"/>
    </changeSet>

    <changeSet id="createIndex charges.external_id" author="">
        <createIndex indexName="idx_charges_external_id"
                     tableName="charges"
                     unique="true">
            <column name="external_id" type="char(26)"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex charges.reference" author="">
        <createIndex indexName="idx_charges_reference"
                     tableName="charges"
                     unique="false">
            <column name="reference"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex charges.created_date" author="">
        <createIndex indexName="idx_charges_created_date"
                     tableName="charges"
                     unique="false">
            <column name="created_date"/>
        </createIndex>
    </changeSet>

    <changeSet id="add service_name column to charges table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="service_name" type="varchar(50)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="migrate legacy states in charges, events table" author="">
        <sql>
            UPDATE charges SET status = 'EXPIRE CANCEL READY' WHERE status = 'EXPIRE CANCEL PENDING';
        </sql>
        <sql>
            UPDATE charge_events SET status = 'EXPIRE CANCEL READY' WHERE status = 'EXPIRE CANCEL PENDING';
        </sql>
        <sql>
            UPDATE charges SET status = 'SYSTEM CANCEL READY' WHERE status = 'CANCEL READY';
        </sql>
        <sql>
            UPDATE charge_events SET status = 'SYSTEM CANCEL READY' WHERE status = 'CANCEL READY';
        </sql>
        <sql>
            UPDATE charges SET status = 'SYSTEM CANCEL ERROR' WHERE status = 'CANCEL ERROR';
        </sql>
        <sql>
            UPDATE charge_events SET status = 'SYSTEM CANCEL ERROR' WHERE status = 'CANCEL ERROR';
        </sql>
    </changeSet>

    <changeSet id="build card_types table" author="">
        <createTable tableName="card_types">
            <column name="id" type="uuid" defaultValueComputed="(uuid_generate_v4())">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="brand" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="varchar(15)">
                <constraints nullable="false"/>
            </column>
            <column name="label" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="build accepted_card_types table" author="">
        <createTable tableName="accepted_card_types">
            <column name="gateway_account_id" type="bigint">
                <constraints primaryKey="true"
                             foreignKeyName="fk__accepted_card_types_gateway_accounts"
                             referencedTableName="gateway_accounts"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="card_type_id" type="uuid">
                <constraints primaryKey="true"
                             foreignKeyName="fk__accepted_card_types_card_type" referencedTableName="card_types"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add email column to charges table" author="">
        <addColumn tableName="charges">
            <column name="email" type="varchar(50)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="Seed database table card_types" author="">
        <loadData file="seed-data/card_types.csv"
                  tableName="card_types">
            <column name="brand" type="string" />
            <column name="type" type="string" />
            <column name="label" type="string" />
        </loadData>
    </changeSet>

    <changeSet id="update email column in charges table to 254 chars" author="">
        <modifyDataType columnName="email"
                        newDataType="varchar(254)"
                        tableName="charges"/>
    </changeSet>

    <changeSet id="build email notifications table" author="">
        <createTable tableName="email_notifications">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account_id" type="bigserial">
                <constraints nullable="false"
                             foreignKeyName="fk__email_notifications_gateway_accounts"
                             referencedTableName="gateway_accounts"
                             referencedColumnNames="id"/>
            </column>
            <column name="template_body" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="" id="drop not null constraint on email notifications table">
        <dropNotNullConstraint columnDataType="text"
                               columnName="template_body"
                               tableName="email_notifications"/>
    </changeSet>

    <changeSet id="add enabled column to email notifications table" author="">
        <addColumn tableName="email_notifications">
            <column name="enabled" type="boolean" defaultValue="true" />
        </addColumn>
    </changeSet>

    <changeSet id="build refunds table" author="">
        <createTable tableName="refunds">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="external_id" type="char(26)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="amount" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(25)">
                <constraints nullable="false"/>
            </column>
            <column name="charge_id" type="bigserial">
                <constraints foreignKeyName="fk__refunds_charges" referencedTableName="charges"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="created_date" type="timestamp without timezone"
                    defaultValueComputed="(now() at time zone 'utc')">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="idx_refunds_external_id"
                     tableName="refunds"
                     unique="true">
            <column name="external_id" type="char(26)"/>
        </createIndex>
    </changeSet>

    <changeSet id="add type(TEST/LIVE) column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="type" type="varchar(10)" defaultValue="TEST" remarks="possible values (TEST/LIVE)">
                <constraints nullable="false" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="build confirmation_details table" author="">
        <createTable tableName="confirmation_details">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charge_id" type="bigserial">
                <constraints foreignKeyName="fk__confirmation_details_charges" unique="true" referencedTableName="charges"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="last_digits_card_number" type="char(4)">
                <constraints nullable="false"/>
            </column>
            <column name="cardholder_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="expiry_date" type="varchar(6)">
                <constraints nullable="false"/>
            </column>
            <column name="address_line1" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address_line2" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_postcode" type="varchar(25)">
                <constraints nullable="false"/>
            </column>
            <column name="address_city" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address_county" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_country" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="build notification_credentials table" author="">
        <createTable tableName="notification_credentials">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account_id" type="bigint">
                <constraints foreignKeyName="fk__notification_credentials_gateway_accounts"
                             referencedTableName="gateway_accounts"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="username" type="varchar(25)">
                <constraints nullable="false"/>
            </column>
            <column name="password" type="varchar(25)">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add card_brand columns to charges table" author="">
        <addColumn tableName="charges">
            <column name="card_brand" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="update password lenghth to 100 characters" author="">
        <modifyDataType columnName="password"
                        newDataType="varchar(100)"
                        tableName="notification_credentials"/>
    </changeSet>

    <changeSet id="add analytics_id and description to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="description" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="analytics_id" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add card details columns to charges table" author="">
        <addColumn tableName="charges">
            <column name="last_digits_card_number" type="char(4)">
                <constraints nullable="true"/>
            </column>
            <column name="cardholder_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="expiry_date" type="varchar(6)">
                <constraints nullable="true"/>
            </column>
            <column name="address_line1" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_line2" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_postcode" type="varchar(25)">
                <constraints nullable="true"/>
            </column>
            <column name="address_city" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_county" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_country" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add reference column to refunds table" author="">
        <addColumn tableName="refunds">
            <column name="reference" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="migrate existing refund external ids" author="">
        <sql>
            UPDATE refunds SET reference = external_id;
        </sql>
    </changeSet>

    <changeSet id="add gateway transaction id column to charge_events table" author="">
        <addColumn tableName="charge_events">
            <column name="gateway_transaction_id" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="" id="dropTable-confirmation-details-table">
        <dropTable cascadeConstraints="true"
                   tableName="confirmation_details"/>
    </changeSet>

    <changeSet id="add gateway event date time column to charge_events table" author="">
        <addColumn tableName="charge_events">
            <column name="gateway_event_date" type="timestamp without timezone">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="createIndex charge_events.charge_id" author="">
        <createIndex indexName="idx_charge_events_charge_id"
                     tableName="charge_events"
                     unique="false">
            <column name="charge_id" type="bigserial"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex refunds.charge_id" author="">
        <createIndex indexName="idx_refunds_charge_id"
                     tableName="refunds"
                     unique="false">
            <column name="charge_id" type="bigserial"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex card_types.brand" author="">
        <createIndex indexName="idx_card_types_brand"
                     tableName="card_types"
                     unique="false">
            <column name="brand" type="text"/>
        </createIndex>
    </changeSet>

    <changeSet id="add flag for 3ds feature toggle on gateway account" author="">
        <addColumn tableName="gateway_accounts">
            <column name="requires_3ds" type="boolean" defaultValue="false"/>
        </addColumn>
    </changeSet>

    <changeSet id="add 3ds details to charge table" author="">
        <addColumn tableName="charges">
            <column name="pa_request_3ds" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="issuer_url_3ds" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add provider session id to charge table" author="">
        <addColumn tableName="charges">
            <column name="provider_session_id" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="createIndex charges.status" author="">
        <createIndex indexName="idx_charges_status"
                     tableName="charges"
                     unique="false">
            <column name="status" type="text"/>
        </createIndex>
    </changeSet>

    <changeSet id="add requires_3ds to card_types table" author="">
        <addColumn tableName="card_types">
            <column name="requires_3ds" type="boolean" defaultValue="false"/>
        </addColumn>
    </changeSet>

    <changeSet author="" id="insert maestro card type">
        <insert tableName="card_types">
            <column name="brand" value="maestro"/>
            <column name="type" value="DEBIT"/>
            <column name="label" value="Maestro"/>
            <column name="requires_3ds" value="true"/>
        </insert>
    </changeSet>

    <changeSet id="createIndex refunds.reference" author="">
        <createIndex indexName="idx_refunds_reference"
                     tableName="refunds"
                     unique="false">
            <column name="reference" type="text"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex gateway_accounts.payment_provider" author="">
        <createIndex indexName="idx_gateway_accounts_payment_provider"
                     tableName="gateway_accounts"
                     unique="false">
            <column name="payment_provider" type="varchar(255)"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex charges.gateway_account_id" author="">
        <createIndex indexName="idx_charges_gateway_account_id"
                     tableName="charges"
                     unique="false">
            <column name="gateway_account_id" type="bigserial"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex refunds.created_date" author="">
        <createIndex indexName="idx_refunds_created_date"
                     tableName="refunds"
                     unique="false">
            <column name="created_date" />
        </createIndex>
    </changeSet>

    <changeSet id="build refunds_history table" author="">
        <createTable tableName="refunds_history">
            <column name="id" type="bigserial"/>
            <column name="external_id" type="char(26)" />
            <column name="amount" type="bigint" />
            <column name="status" type="varchar(25)" />
            <column name="charge_id" type="bigserial" />
            <column name="created_date" type="timestamp without timezone" />
            <column name="version" type="bigint" defaultValue="0" />
            <column name="reference" type="text"/>
            <column name="history_start_date" type="timestamp without timezone" />
            <column name="history_end_date" type="timestamp without timezone" />
        </createTable>
    </changeSet>

    <changeSet id="createIndex refunds_history.charge_id" author="">
        <createIndex indexName="idx_refunds_history_charge_id"
                     tableName="refunds_history"
                     unique="false">
            <column name="charge_id" type="bigserial"/>
        </createIndex>
    </changeSet>

    <changeSet id="add user_external_id column to refunds table" author="">
        <addColumn tableName="refunds">
            <column name="user_external_id" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add user_external_id column to refunds_history table" author="">
        <addColumn tableName="refunds_history">
            <column name="user_external_id" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add notify settings column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="notify_settings" type="json">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add html_out_3ds to charges table" author="">
        <addColumn tableName="charges">
            <column name="html_out_3ds" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add md_3ds to charges table" author="">
        <addColumn tableName="charges">
            <column name="md_3ds" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="increase width of notification_credentials username, password columns" author="">
        <modifyDataType
            tableName="notification_credentials"
            columnName="username"
            newDataType="varchar(255)"/>
        <modifyDataType
            tableName="notification_credentials"
            columnName="password"
            newDataType="varchar(255)"/>
    </changeSet>

    <changeSet id="add index to charges.gateway_transaction_id" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_charges_gateway_transaction_id ON charges (gateway_transaction_id);
        </sql>
    </changeSet>

    <changeSet id="add index to tokens.secure_redirect_token" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_tokens_secure_redirect_token ON tokens (secure_redirect_token);
        </sql>
    </changeSet>

    <changeSet id="add trigram index to charges.reference" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_charges_references_gin_idx  ON charges USING GIN (reference gin_trgm_ops);
        </sql>
    </changeSet>

    <changeSet id="add trigram index to charges.email" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_charges_email_gin_idx ON charges USING GIN (email gin_trgm_ops);
        </sql>
    </changeSet>

    <changeSet id="add trigram index to refunds.reference" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_refunds_reference_gin_idx  ON refunds USING GIN (reference gin_trgm_ops);
        </sql>
    </changeSet>

    <changeSet id="add index to status column on refunds table" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_refunds_status ON refunds (status);
        </sql>
    </changeSet>

    <changeSet id="Drop trigram index to refunds.reference" runInTransaction="false" author="">
        <sql>
            DROP INDEX idx_refunds_reference_gin_idx;
        </sql>
    </changeSet>

    <changeSet id="add trigram index to lowered charges.email " runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_lower_charges_email_gin_idx ON charges USING GIN (lower(email) gin_trgm_ops);
        </sql>
    </changeSet>

    <changeSet id="add trigram index to lowered charges.reference" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_lower_charges_reference_gin_idx  ON charges USING GIN (lower(reference) gin_trgm_ops);
        </sql>
    </changeSet>

    <changeSet id="Drop trigram index to charges.reference" runInTransaction="false" author="">
        <sql>
            DROP INDEX idx_charges_references_gin_idx;
        </sql>
    </changeSet>

    <changeSet id="Drop trigram index to charges.email" runInTransaction="false" author="">
        <sql>
            DROP INDEX idx_charges_email_gin_idx;
        </sql>
    </changeSet>

    <changeSet id="Add language column to charges table" author="">
        <addColumn tableName="charges">
            <column name="language" type="varchar(2)"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add default value to language column" author="">
        <addDefaultValue tableName="charges"
                         columnName="language"
                         defaultValue="en"
        />
    </changeSet>

    <changeSet id="Update language column to default value" author="">
        <update tableName="charges">
            <column name="language" value="en"/>
            <where>language IS NULL</where>
        </update>
    </changeSet>

    <changeSet id="add trigram index to lowered charges.cardholder_name" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_lower_charges_cardholder_name_gin_idx  ON charges USING GIN (lower(cardholder_name) gin_trgm_ops);
        </sql>
    </changeSet>

    <changeSet id="Add delayed_capture column to charges table" author="">
        <addColumn tableName="charges">
            <column name="delayed_capture" type="boolean"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add default value to delayed_capture column" author="">
        <addDefaultValue tableName="charges"
                         columnName="delayed_capture"
                         defaultValue='false'
        />
    </changeSet>

    <changeSet id="Update delayed_capture column to default value" author="">
        <update tableName="charges">
            <column name="delayed_capture" value='false'/>
            <where>delayed_capture IS NULL</where>
        </update>
    </changeSet>

    <changeSet id="Add corporate credit card surcharge amount column to gateway accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="corporate_credit_card_surcharge_amount" type="bigint"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add default value to corporate credit card surcharge amount column" author="">
        <addDefaultValue tableName="gateway_accounts"
                         columnName="corporate_credit_card_surcharge_amount"
                         defaultValue="0"
        />
    </changeSet>

    <changeSet id="Update corporate credit card surcharge amount column to default value" author="">
        <update tableName="gateway_accounts">
            <column name="corporate_credit_card_surcharge_amount" value="0"/>
            <where>corporate_credit_card_surcharge_amount IS NULL</where>
        </update>
    </changeSet>

    <changeSet id="Add corporate debit card surcharge amount column to gateway accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="corporate_debit_card_surcharge_amount" type="bigint"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add default value to corporate debit card surcharge amount column" author="">
        <addDefaultValue tableName="gateway_accounts"
                         columnName="corporate_debit_card_surcharge_amount"
                         defaultValue="0"
        />
    </changeSet>

    <changeSet id="Update corporate debit card surcharge amount column to default value" author="">
        <update tableName="gateway_accounts">
            <column name="corporate_debit_card_surcharge_amount" value="0"/>
            <where>corporate_debit_card_surcharge_amount IS NULL</where>
        </update>
    </changeSet>

    <changeSet id="add type column to email notifications table" author="">
        <addColumn tableName="email_notifications">
            <column name="type" type="VARCHAR(36)" >
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="backfill existing notifications with PAYMENT_CONFIRMED value" author="">
        <sql>
            UPDATE email_notifications SET type = 'PAYMENT_CONFIRMED';
        </sql>
    </changeSet>

    <changeSet id="add email_collection_mode column to gateway accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="email_collection_mode" type="VARCHAR(36)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add default value to email_collection_mode in gateway accounts table" author="">
        <addDefaultValue tableName="gateway_accounts" columnName="email_collection_mode" defaultValue="MANDATORY"/>
    </changeSet>

    <changeSet id="backfill existing gateway accounts with MANDATORY default value" author="">
        <sql>
            UPDATE gateway_accounts SET email_collection_mode = 'MANDATORY';
        </sql>
    </changeSet>

    <changeSet id="add first digits card number columns to charges table" author="">
        <addColumn tableName="charges">
            <column name="first_digits_card_number" type="VARCHAR(6)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add index to charges.last_digits_card_number" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_last_digits_card_number_idx ON charges(last_digits_card_number);
        </sql>
    </changeSet>

    <changeSet id="add index to charges.first_digits_card_number" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_first_digits_card_number_idx ON charges(first_digits_card_number);
        </sql>
    </changeSet>

    <changeSet id="add corporate surcharge column to charges table" author="">
        <addColumn tableName="charges">
            <column name="corporate_surcharge" type="BIGINT">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add allow_web_payments to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="allow_web_payments" type="boolean" defaultValue="false">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="Add corporate prepaid credit card surcharge amount column to gateway accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="corporate_prepaid_credit_card_surcharge_amount" type="bigint"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add default value to corporate prepaid credit card surcharge amount column" author="">
        <addDefaultValue tableName="gateway_accounts"
                         columnName="corporate_prepaid_credit_card_surcharge_amount"
                         defaultValue="0"
        />
    </changeSet>

    <changeSet id="Update corporate prepaid credit card surcharge amount column to default value" author="">
        <update tableName="gateway_accounts">
            <column name="corporate_prepaid_credit_card_surcharge_amount" value="0"/>
            <where>corporate_prepaid_credit_card_surcharge_amount IS NULL</where>
        </update>
    </changeSet>

    <changeSet id="Add corporate prepaid debit card surcharge amount column to gateway accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="corporate_prepaid_debit_card_surcharge_amount" type="bigint"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add default value to corporate prepaid debit card surcharge amount column" author="">
        <addDefaultValue tableName="gateway_accounts"
                         columnName="corporate_prepaid_debit_card_surcharge_amount"
                         defaultValue="0"
        />
    </changeSet>

    <changeSet id="Update corporate prepaid debit card surcharge amount column to default value" author="">
        <update tableName="gateway_accounts">
            <column name="corporate_prepaid_debit_card_surcharge_amount" value="0"/>
            <where>corporate_prepaid_debit_card_surcharge_amount IS NULL</where>
        </update>
    </changeSet>

    <changeSet id="add wallet column to charges table" author="">
        <addColumn tableName="charges">
            <column name="wallet" type="varchar(50)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add allow_apple_pay and allow_google_pay to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="allow_apple_pay" type="boolean">
            </column>
        </addColumn>
        <addColumn tableName="gateway_accounts">
            <column name="allow_google_pay" type="boolean">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add default to allow_apple_pay and allow_google_pay" author="">
        <addDefaultValue tableName="gateway_accounts" columnName="allow_apple_pay" defaultValue="false"/>
        <addDefaultValue tableName="gateway_accounts" columnName="allow_google_pay" defaultValue="false"/>
    </changeSet>

    <changeSet id="update allow_apple_pay with default value" author="">
        <update tableName="gateway_accounts">
            <column name="allow_apple_pay" value="false"/>
        </update>
    </changeSet>

    <changeSet id="update allow_google_pay with default value" author="">
        <update tableName="gateway_accounts">
            <column name="allow_google_pay" value="false"/>
        </update>
    </changeSet>

    <changeSet id="add gateway_accounts_stripe_setup table" author="">
        <createTable tableName="gateway_accounts_stripe_setup">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="gateway_account_id" type="bigint">
                <constraints foreignKeyName="fk__gateway_accounts_stripe_setup_gateway_accounts"
                             referencedTableName="gateway_accounts" referencedColumnNames="id"
                             nullable="false"/>
            </column>
            <column name="task" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add index to gateway_account_id column in gateway_accounts_stripe_setup table" author="">
        <createIndex tableName="gateway_accounts_stripe_setup"
                     indexName="idx_gateway_accounts_stripe_setup_gateway_account_id" unique="false">
            <column name="gateway_account_id" type="bigint"/>
        </createIndex>
    </changeSet>

    <changeSet id="drop column `allow_web_payments` from gateway_accounts" author="">
        <sql>
            alter table gateway_accounts drop column allow_web_payments;
        </sql>
    </changeSet>

    <changeSet id="add fee table" author="">
        <createTable tableName="fees">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="external_id" type="char(26)" />
            <column name="charge_id" type="bigserial">
                <constraints foreignKeyName="fk__charge_fees"
                             referencedTableName="charges"
                             referencedColumnNames="id"
                             unique="true"
                             nullable="false" />
            </column>
            <column name="amount_due" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="amount_collected" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="created_date" type="timestamp without timezone" />
            <column name="collected_date" type="timestamp without timezone" />
            <column name="gateway_transaction_id"  type="text">
                <constraints nullable="true" />
            </column>
            <column name="gateway_processing_details" type="jsonb" />
        </createTable>
    </changeSet>

    <changeSet id="index gateway_transaction_id, external_id and charge_id columns for fee table" author="">
        <createIndex tableName="fees" indexName="idx_fees_gateway_transaction_id">
            <column name="gateway_transaction_id" />
        </createIndex>

        <createIndex tableName="fees" indexName="idx_fees_external_id">
            <column name="external_id" />
        </createIndex>

        <createIndex tableName="fees" indexName="idx_fees_charge_id">
            <column name="charge_id" />
        </createIndex>
    </changeSet>

    <changeSet id="add column and index for refunds gateway transaction ID" author="">
        <addColumn tableName="refunds">
            <column name="gateway_transaction_id" type="text">
                <constraints nullable="true" unique="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add index concurrently to new refunds gateway_transaction_id column" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_refunds_gateway_transaction_id on refunds(gateway_transaction_id);
        </sql>
    </changeSet>

    <changeSet id="add generic gateway processing details column" author="">
        <addColumn tableName="refunds">
            <column name="gateway_processing_details" type="jsonb">
                <constraints nullable="true" unique="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add column gateway_processing_details to charges" author="">
        <addColumn tableName="charges">
            <column name="gateway_processing_details" type="jsonb">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>


    <changeSet id="add version to fees table" author="">
        <addColumn tableName="fees">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add column external_metadata to charges" author="">
        <addColumn tableName="charges">
            <column name="external_metadata" type="jsonb">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>


    <changeSet id="add allow_zero_amount to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="allow_zero_amount" type="boolean">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add default to allow_zero_amount" author="">
        <addDefaultValue tableName="gateway_accounts" columnName="allow_zero_amount" defaultValue="false"/>
    </changeSet>

    <changeSet id="update allow_zero_amount with default value" author="">
        <update tableName="gateway_accounts">
            <column name="allow_zero_amount" value="false"/>
        </update>
    </changeSet>

    <changeSet id="add gateway_transaction_id column to refunds_history table" author="">
        <addColumn tableName="refunds_history">
            <column name="gateway_transaction_id" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add created_date to tokens table" author="">
        <addColumn tableName="tokens">
            <column name="created_date" type="timestamp without timezone">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add default date to created_date on tokens table" author="">
        <addDefaultValue tableName="tokens" columnName="created_date" columnDataType="timestamp without timezone" defaultValueComputed="(now() at time zone 'utc')" />
    </changeSet>

    <changeSet id="update created_date with default value on tokens table" author="">
        <update tableName="tokens">
            <column name ="created_date" valueComputed="(now() at time zone 'utc')" />
        </update>
    </changeSet>

    <changeSet id="add index concurrently to created_date column on tokens table" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_created_date on tokens(created_date);
        </sql>
    </changeSet>

    <changeSet id="add emitted_events" author="">
        <createTable tableName="emitted_events">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="resource_type" type="varchar(100)" />
            <column name="resource_external_id" type="varchar(50)" />
            <column name="event_date" type="timestamp without timezone" />
            <column name="event_type" type="varchar(254)" />
            <column name="emitted_date" type="timestamp without timezone" />
        </createTable>
        <createIndex indexName="idx_emitted_events_resource_type_and_external_id"
                     tableName="emitted_events"
                     unique="false">
            <column name="resource_type" type="varchar(100)"/>
            <column name="resource_external_id" type="varchar(50)"/>
        </createIndex>
    </changeSet>

    <changeSet id="update return_url column to allow null values" author="">
        <dropNotNullConstraint
                tableName="charges"
                columnName="return_url" />
    </changeSet>

    <changeSet id="add integration_version_3ds column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="integration_version_3ds" type="smallint">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add default to integration_version_3ds" author="">
        <addDefaultValue tableName="gateway_accounts" columnName="integration_version_3ds" defaultValue="1"/>
    </changeSet>

    <changeSet id="update integration_version_3ds to be non-nullable" author="">
        <addNotNullConstraint tableName="gateway_accounts"
                              columnName="integration_version_3ds"
                              defaultNullValue="1"/>
    </changeSet>

    <changeSet id="add integration_version_3ds column to charges table" author="">
        <addColumn tableName="charges">
            <column name="integration_version_3ds" type="smallint">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add lower-case index to charges.reference" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_lower_charges_reference ON charges (LOWER(reference));
        </sql>
    </changeSet>

    <changeSet id="add parity-check columns" author="">
        <addColumn tableName="charges">
            <column name="parity_check_status" type="varchar(100)">
            </column>
        </addColumn>
        <addColumn tableName="charges">
            <column name="parity_check_date" type="timestamp without timezone">
            </column>
        </addColumn>
        <createIndex indexName="idx_charges_parity_check_status"
                     tableName="charges"
                     unique="false">
            <column name="parity_check_status"/>
        </createIndex>
        <createIndex indexName="idx_charges_parity_check_date"
                     tableName="charges"
                     unique="false">
            <column name="parity_check_date"/>
        </createIndex>
    </changeSet>

    <changeSet id="add used column to tokens table" author="">
        <addColumn tableName="tokens">
            <column name="used" type="boolean">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="update existing tokens to have a used value of false" author="">
        <update tableName="tokens">
            <column name="used" value="false"/>
            <where>used IS NULL</where>
        </update>
    </changeSet>

    <changeSet id="add worldpay 3ds flex challenge data columns" author="">
        <addColumn tableName="charges">
            <column name="worldpay_challenge_acs_url_3ds" type="text"/>
            <column name="worldpay_challenge_transaction_id_3ds" type="text"/>
            <column name="worldpay_challenge_payload_3ds" type="text"/>
            <column name="version_3ds" type="varchar(10)"/>
        </addColumn>
    </changeSet>

    <changeSet id="add card type column" author="">
        <addColumn tableName="charges">
            <column name="card_type" type="varchar(20)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add partial index to emitted_events emitted_date column" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_emitted_events_null_emitted_date ON emitted_events (emitted_date) where emitted_date is null;
        </sql>
    </changeSet>

    <changeSet id="add worldpay_3ds_flex_credentials table" author="">
        <createTable tableName="worldpay_3ds_flex_credentials">
            <column name="gateway_account_id" type="BIGINT">
                <constraints unique="true" nullable="false" foreignKeyName="fk__worldpay_3ds_flex_credentials_account_id" referencedTableName="gateway_accounts" referencedColumnNames="id"/>
            </column>
            <column name="issuer" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="organisational_unit_id" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="jwt_mac_key" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="drop worldpay_3ds_flex_credentials table" author="">
        <dropTable tableName="worldpay_3ds_flex_credentials"/>
    </changeSet>

    <changeSet id="add worldpay_3ds_flex_credentials id column" author="">
        <createTable tableName="worldpay_3ds_flex_credentials">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="gateway_account_id" type="BIGINT">
                <constraints unique="true" nullable="false" foreignKeyName="fk__worldpay_3ds_flex_credentials_account_id" referencedTableName="gateway_accounts" referencedColumnNames="id"/>
            </column>
            <column name="issuer" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="organisational_unit_id" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="jwt_mac_key" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add send_payer_ip_address_to_gateway column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="send_payer_ip_address_to_gateway" type="boolean" defaultValue="false">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add do_not_retry_emit_until to emitted_events table" author="">
        <addColumn tableName="emitted_events">
            <column name="do_not_retry_emit_until" type="timestamp with time zone">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add index to emitted_events.do_not_retry_emit_until" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_emitted_events_do_not_retry_emit_until ON emitted_events (do_not_retry_emit_until);
        </sql>
    </changeSet>

    <changeSet id="add block prepaid cards column for gateway accounts" author="">
        <addColumn tableName="gateway_accounts">
            <column name="block_prepaid_cards" type="boolean" />
        </addColumn>
    </changeSet>

    <changeSet id="default block_prepaid_cards column to false" author="">
        <addDefaultValue tableName="gateway_accounts" columnName="block_prepaid_cards" defaultValue="false" />
    </changeSet>

    <changeSet id="update current block_prepaid_cards column to default value" author="">
        <update tableName="gateway_accounts">
            <column name="block_prepaid_cards" value="false" />
        </update>
    </changeSet>

    <changeSet id="refunds and refunds_history table has user_email column" author="">
        <addColumn tableName="refunds">
            <column name="user_email" type="varchar(255)" >
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="refunds_history">
            <column name="user_email" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add source column to charges table" author="">
        <addColumn tableName="charges">
            <column name="source" type="varchar(50)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add allow_moto to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="allow_moto" type="boolean">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add default to allow_moto" author="">
        <addDefaultValue tableName="gateway_accounts" columnName="allow_moto" defaultValue="false"/>
    </changeSet>

    <changeSet id="update allow_moto with default value" author="">
        <update tableName="gateway_accounts">
            <column name="allow_moto" value="false"/>
        </update>
    </changeSet>

    <changeSet id="add moto to charges table" author="">
        <addColumn tableName="charges">
            <column name="moto" type="boolean">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add default to moto" author="">
        <addDefaultValue tableName="charges" columnName="moto" defaultValue="false"/>
    </changeSet>

    <changeSet id="add charge_external_id column to refunds and refunds_history table" author="">
        <addColumn tableName="refunds">
            <column name="charge_external_id" type="char(26)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="refunds_history">
            <column name="charge_external_id" type="char(26)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create charge external id index on refunds table" author="">
        <createIndex indexName="idx_refunds_charge_external_id"
                     tableName="refunds"
                     unique="false">
            <column name="charge_external_id" type="char(26)"/>
        </createIndex>
    </changeSet>

    <changeSet id="drop foreign key constraint on charge_id on refunds table" author="">
        <dropForeignKeyConstraint
                baseTableName="refunds"
                constraintName="fk__refunds_charges"/>
    </changeSet>

    <changeSet id="drop index on charge_id on refunds table" author="">
        <dropIndex tableName="refunds" indexName="idx_refunds_charge_id"/>
    </changeSet>

    <changeSet id="drop index on charge_id on refunds_history table" author="">
        <dropIndex tableName="refunds_history" indexName="idx_refunds_history_charge_id"/>
    </changeSet>

    <changeSet id="create charge_external_id index on refunds_history table" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_refunds_history_charge_external_id ON refunds_history (charge_external_id);
        </sql>
    </changeSet>

    <changeSet id="drop charge_id from refunds table" runInTransaction="false" author="">
        <dropColumn tableName="refunds" columnName="charge_id"/>
    </changeSet>

    <changeSet id="drop charge_id from refunds_history table" runInTransaction="false" author="">
        <dropColumn tableName="refunds_history" columnName="charge_id"/>
    </changeSet>

    <changeSet id="add swap table in order to truncate emitted events safely" author="">
        <sql>CREATE TABLE emitted_events_swp (LIKE emitted_events INCLUDING ALL);</sql>
    </changeSet>

    <changeSet id="remove emitted events swap table following use" author="">
        <dropTable tableName="emitted_events_swp" />
    </changeSet>

    <changeSet id="drop reference from refunds table" runInTransaction="false" author="">
        <dropColumn tableName="refunds" columnName="reference"/>
    </changeSet>

    <changeSet id="drop reference from refunds_history table" runInTransaction="false" author="">
        <dropColumn tableName="refunds_history" columnName="reference"/>
    </changeSet>

    <changeSet id="drop gateway_processing_details from refunds table" runInTransaction="false" author="">
        <dropColumn tableName="refunds" columnName="gateway_processing_details"/>
    </changeSet>

    <changeSet id="add address_state_province column to charges table" author="">
        <addColumn tableName="charges">
            <column name="address_state_province" type="varchar(2)">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add moto_mask_card_number_input column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="moto_mask_card_number_input" type="boolean" defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add moto_mask_card_security_code_input column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="moto_mask_card_security_code_input" type="boolean" defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add parity-check columns to refunds" author="">
        <addColumn tableName="refunds">
            <column name="parity_check_status" type="varchar(100)">
            </column>
        </addColumn>
        <addColumn tableName="refunds">
            <column name="parity_check_date" type="timestamp without timezone">
            </column>
        </addColumn>
        <createIndex indexName="idx_refunds_parity_check_date"
                     tableName="refunds"
                     unique="false">
            <column name="parity_check_date"/>
        </createIndex>
    </changeSet>
    <changeSet id="add parity-check columns to refunds history" author="">
        <addColumn tableName="refunds_history">
            <column name="parity_check_status" type="varchar(100)">
            </column>
        </addColumn>
        <addColumn tableName="refunds_history">
            <column name="parity_check_date" type="timestamp without timezone">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add external_id column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="external_id" type="varchar(32)" defaultValueComputed="replace(uuid_generate_v4()::VARCHAR,'-'::text,''::text)">
                <constraints nullable="false" unique="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add exemption_engine column to worldpay_3ds_flex_credentials table" author="">
        <addColumn tableName="worldpay_3ds_flex_credentials">
            <column name="exemption_engine" type="boolean" defaultValue="false" />
        </addColumn>
    </changeSet>

    <changeSet id="add exemption_3ds column to charges table" author="">
        <addColumn tableName="charges">
            <column name="exemption_3ds" type="VARCHAR(50)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add allow_telephone_payment_notifications to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="allow_telephone_payment_notifications" type="boolean">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add default to allow_telephone_payment_notifications" author="">
        <addDefaultValue tableName="gateway_accounts" columnName="allow_telephone_payment_notifications" defaultValue="false"/>
    </changeSet>

    <changeSet id="update allow_telephone_payment_notifications with default value" author="">
        <update tableName="gateway_accounts">
            <column name="allow_telephone_payment_notifications" value="false"/>
        </update>
    </changeSet>

    <changeSet id="create empty table to test concourse db migration" author="">
        <createTable tableName="test_concourse_db_migration">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="remove empty table to test concourse db migration" author="">
        <dropTable cascadeConstraints="true" tableName="test_concourse_db_migration" />
    </changeSet>

    <changeSet id="build gateway_account_credentials table" author="">
        <createTable tableName="gateway_account_credentials">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="payment_provider" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="credentials" type="json" defaultValue="{}">
                <constraints nullable="false" unique="false"/>
            </column>
            <column name="state" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="active_start_date" type="timestamp without timezone"></column>
            <column name="active_end_date" type="timestamp without timezone"></column>
            <column name="created_date" type="timestamp without timezone" defaultValueComputed="(now() at time zone 'utc')">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_by_user_external_id" type="varchar(255)"></column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>

            <column name="gateway_account_id" type="bigserial">
                <constraints foreignKeyName="fk__gateway_account_credentials_gateway_accounts" referencedTableName="gateway_accounts"
                             referencedColumnNames="id" nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="add column payment_provider to charges" author="">
        <addColumn tableName="charges">
            <column name="payment_provider" type="varchar(255)">
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="add provider_switch_enabled to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="provider_switch_enabled" type="boolean" defaultValue="false">
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="add external id to gateway_account_credentials table" author="">
        <addColumn tableName="gateway_account_credentials">
            <column name="external_id" type="varchar(32)" defaultValueComputed="replace(uuid_generate_v4()::VARCHAR,'-'::text,''::text)">
                <constraints nullable="false" unique="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add send_payer_email_to_gateway column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="send_payer_email_to_gateway" type="boolean" defaultValue="false">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add gateway_account_credential_id to charges" author="">
        <addColumn tableName="charges">
            <column name="gateway_account_credential_id" type="bigserial">
                <constraints foreignKeyName="fk__charges_gateway_account_credentials"
                             referencedTableName="gateway_account_credentials"
                             referencedColumnNames="id" nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="set send_payer_email_to_gateway to not null" author="">
        <addNotNullConstraint tableName="gateway_accounts" columnName="send_payer_email_to_gateway"/>
    </changeSet>

    <changeSet id="build gateway_account_credentials_history table" author="">
        <createTable tableName="gateway_account_credentials_history">
            <column name="id" type="bigserial"/>
            <column name="payment_provider" type="varchar(255)"/>
            <column name="credentials" type="json"/>
            <column name="state" type="varchar(255)"/>
            <column name="active_start_date" type="timestamp without timezone"/>
            <column name="active_end_date" type="timestamp without timezone"/>
            <column name="created_date" type="timestamp without timezone"/>
            <column name="last_updated_by_user_external_id" type="varchar(255)"/>
            <column name="version" type="bigint" defaultValue="0"/>
            <column name="gateway_account_id" type="bigserial"/>
            <column name="external_id" type="varchar(32)"/>
            <column name="history_start_date" type="timestamp without timezone"/>
            <column name="history_end_date" type="timestamp without timezone"/>
        </createTable>
    </changeSet>

    <changeSet id="drop credentials from gateway_accounts table" runInTransaction="false" author="">
        <dropColumn tableName="gateway_accounts" columnName="credentials"/>
    </changeSet>

    <changeSet id="drop not null constraint on payment_provider on table gateway_accounts" author="">
        <dropNotNullConstraint columnName="payment_provider"
                               tableName="gateway_accounts"/>
    </changeSet>

    <changeSet id="drop payment_provider from gateway_accounts table" runInTransaction="false" author="">
        <dropColumn tableName="gateway_accounts" columnName="payment_provider"/>
    </changeSet>

    <changeSet id="add service id to gateway accounts" author="">
        <addColumn tableName="gateway_accounts">
            <column name="service_id" type="varchar(32)"/>
        </addColumn>
        <createIndex tableName="gateway_accounts" indexName="idx_gateway_accounts_service_id">
            <column name="service_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="add service id to charges" author="">
        <addColumn tableName="charges">
            <column name="service_id" type="varchar(32)"/>
        </addColumn>
    </changeSet>

    <changeSet id="add send_reference_to_gateway column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="send_reference_to_gateway" type="boolean" defaultValue="false">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add requires_additional_kyc_data to gateway account" author="">
        <addColumn tableName="gateway_accounts">
            <column name="requires_additional_kyc_data" type="boolean" defaultValue="false"/>
        </addColumn>
    </changeSet>
    <changeSet id="drop corporate_prepaid_credit_card_surcharge_amount from gateway_accounts table" runInTransaction="false" author="">
        <dropColumn tableName="gateway_accounts" columnName="corporate_prepaid_credit_card_surcharge_amount"/>
    </changeSet>
    <changeSet id="add fee_type column to fees table" author="">
        <addColumn tableName="fees">
            <column name="fee_type" type="varchar(30)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="drop unique constraint for charge_id column on fee table to allow for multiple fees per charge" author="">
        <dropUniqueConstraint
                tableName="fees"
                constraintName="fees_charge_id_key"
                uniqueColumns="charge_id" />
    </changeSet>

    <changeSet id="create agreements table" author="">
        <createTable tableName="agreements">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="created_date" type="timestamp without timezone"
                    defaultValueComputed="(now() at time zone 'utc')">
                <constraints nullable="false"/>
            </column>
            <column name="external_id" type="varchar(32)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="gateway_account_id" type="bigserial">
                <constraints foreignKeyName="fk__agreements_gateway_accounts" referencedTableName="gateway_accounts"
                         referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="service_id" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="live" type="boolean">
                <constraints nullable="false"/>
            </column>
            <column name="reference" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="save_payment_instrument_to_agreement_agreement_id_charges" author="">
        <addColumn tableName="charges">
            <column name="save_payment_instrument_to_agreement" type="boolean"  defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="charges">
            <column name="agreement_id" type="varchar(26)" />
        </addColumn>

    </changeSet>

    <changeSet id="add_payment_instruments_table" author="">

        <createTable tableName="payment_instruments">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="created_date" type="timestamp without timezone"
                    defaultValueComputed="(now() at time zone 'utc')">
             <constraints nullable="false"/>
            </column>
            <column name="external_id" type="varchar(32)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="last_digits_card_number" type="char(4)">
                <constraints nullable="true"/>
            </column>
            <column name="cardholder_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="expiry_date" type="varchar(6)">
                <constraints nullable="true"/>
            </column>
            <column name="address_line1" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_line2" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_postcode" type="varchar(25)">
                <constraints nullable="true"/>
            </column>
            <column name="address_city" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_county" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_country" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="card_brand" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="start_date" type="timestamp without timezone">
                <constraints nullable="true"/>
            </column>
            <column name="recurring_auth_token" type="jsonb">
                <constraints nullable="true"/>
            </column>
        </createTable>

    </changeSet>

    <changeSet id="add payment_instrument_id to charges" author="">
        <addColumn tableName="charges">
            <column name="payment_instrument_id" type="bigint">
                <constraints foreignKeyName="fk__charges_payment_instruments"
                             referencedTableName="payment_instruments"
                             referencedColumnNames="id" nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add payment_instrument_id to agreements" author="">
        <addColumn tableName="agreements">
            <column name="payment_instrument_id" type="bigint">
                <constraints foreignKeyName="fk__agreements_payment_instruments"
                             referencedTableName="payment_instruments"
                             referencedColumnNames="id" nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add allow_authorisation_api to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="allow_authorisation_api" type="boolean" defaultValue="false"/>
        </addColumn>
    </changeSet>

    <changeSet id="add card type, address_state_province, first_digits_card_number columns to payment_instruments table" author="">
        <addColumn tableName="payment_instruments">
            <column name="card_type" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="payment_instruments">
            <column name="first_digits_card_number" type="varchar(6)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
        <addColumn tableName="payment_instruments">
            <column name="address_state_province" type="varchar(2)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add authorisation_mode to charges table" author="">
        <addColumn tableName="charges">
            <column name="authorisation_mode" type="varchar(30)" defaultValue="web">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add description, user_identifier to agreements table" author="">
        <addColumn tableName="agreements">
            <column name="description" type="varchar(255)">
                <constraints nullable="true" unique="false"/>
            </column>
            <column name="user_identifier" type="varchar(255)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="drop column authorisation_mode from charges table" author="">
        <dropColumn tableName="charges" columnName="authorisation_mode"/>
    </changeSet>

    <changeSet id="add authorisation_mode to charges table with default value" author="">
        <addColumn tableName="charges">
            <column name="authorisation_mode" type="varchar(30)" defaultValue="WEB">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="update description on agreeements to not nullable" author="">
        <addNotNullConstraint tableName="agreements" columnName="description" />
    </changeSet>

    <changeSet id="add recurring_enabled to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="recurring_enabled" type="boolean" defaultValue="false"/>
        </addColumn>
    </changeSet>

    <changeSet id="add disabled to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="disabled" type="boolean" defaultValue="false"/>
        </addColumn>
    </changeSet>

    <changeSet id="add disabled_reason to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="disabled_reason" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add updated date to charges table" author="">
        <addColumn tableName="charges">
            <column name="updated_date" type="timestamp without timezone">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="drop not null constraint on payment instruments card type" author="">
        <dropNotNullConstraint tableName="payment_instruments" columnName="card_type" />
    </changeSet>

    <changeSet id="add idempotency table" author="">

        <createTable tableName="idempotency">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="key" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="gateway_account_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="resource_external_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="request_body" type="jsonb">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp without timezone"
                    defaultValueComputed="(now() at time zone 'utc')">
                <constraints nullable="false"/>
            </column>
        </createTable>

    </changeSet>

    <changeSet id="create unique constraint gateway_account_id_and_key_unique on idempotency table" author="">
        <sql>ALTER TABLE idempotency
            ADD CONSTRAINT gateway_account_id_and_key_unique
                UNIQUE (gateway_account_id, key);</sql>
    </changeSet>

    <changeSet id="add agreement_external_id column to payment_instruments table" author="">
        <addColumn tableName="payment_instruments">
            <column name="agreement_external_id" type="varchar(32)">
                <constraints
                        foreignKeyName="fk__payment_instruments_agreements"
                        referencedTableName="agreements"
                        referencedColumnNames="external_id"
                        nullable="true"/>
            </column>
        </addColumn>
        <createIndex tableName="payment_instruments" indexName="idx_payment_instruments_agreement_external_id">
            <column name="agreement_external_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="remove requires_additional_kyc_data field from gateway accounts table" author="">
        <dropColumn tableName="gateway_accounts" columnName="requires_additional_kyc_data"/>
    </changeSet>

    <changeSet id="add agreement_external_id column to charges table" author="">
        <addColumn tableName="charges">
            <column name="agreement_external_id" type="varchar(26)">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="drop agreement_id column from charges table" author="">
        <dropColumn tableName="charges" columnName="agreement_id"/>
    </changeSet>

    <changeSet id="add can_retry column to charges table" author="">
        <addColumn tableName="charges">
            <column name="can_retry" type="boolean"></column>
        </addColumn>
    </changeSet>

    <changeSet id="add cancelled date column to agreements table" author="">
        <addColumn tableName="agreements">
            <column name="cancelled_date" type="timestamp without timezone">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="drop gin indexes" author="">
        <dropIndex indexName="idx_lower_charges_cardholder_name_gin_idx" tableName="charges"/>
        <dropIndex indexName="idx_lower_charges_email_gin_idx" tableName="charges"/>
        <dropIndex indexName="idx_lower_charges_reference_gin_idx" tableName="charges"/>
    </changeSet>

    <changeSet id="add exemption 3ds requested column to charges table" author="">
        <addColumn tableName="charges">
            <column name="exemption_3ds_requested" type="VARCHAR(32)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add corporate_exemptions column to worldpay_3ds_flex_credentials table" author="">
        <addColumn tableName="worldpay_3ds_flex_credentials">
            <column name="corporate_exemptions" type="boolean" defaultValue="false" />
        </addColumn>
    </changeSet>

    <changeSet id="create procedure to run adhoc DML statements" author="">
        <createProcedure dbms="postgresql" procedureName="check_and_execute" >
            create or replace procedure check_and_execute(
                p_dml_sql text,
                p_table_name text,
                p_expected_no_of_rows_to_update_or_delete numeric
            )
            language plpgsql
            as $$ declare
                rows_affected INTEGER;
                total_rows INTEGER;
            begin
                EXECUTE format('SELECT COUNT(*) FROM %I', p_table_name) INTO total_rows;

                if p_expected_no_of_rows_to_update_or_delete >= total_rows then
                    raise exception 'Failed. Expected no. of rows (%) to update/delete can not be same or more than the total number of rows (%) in the table',
                        p_expected_no_of_rows_to_update_or_delete,
                        total_rows;
                end if;

                execute p_dml_sql;
                get diagnostics rows_affected = ROW_COUNT;

                if rows_affected != p_expected_no_of_rows_to_update_or_delete then
                    raise exception 'Failed. Statement expected to update/delete % rows but updating % rows. Changes not commited.',
                        p_expected_no_of_rows_to_update_or_delete,
                        rows_affected;
                end if;

                raise notice 'Success. Statement affected % rows. Expected to update/delete LESS THAN or EQUAL to % rows',
                    rows_affected,
                    p_expected_no_of_rows_to_update_or_delete;
            end; $$
        </createProcedure>
    </changeSet>

    <changeSet id="Add requires_3ds column to charges table" author="">
        <addColumn tableName="charges">
            <column name="requires_3ds" type="boolean"/>
        </addColumn>
    </changeSet>

    <changeSet id="remove notification credentials table" author="">
        <dropTable cascadeConstraints="true" tableName="notification_credentials"/>
    </changeSet>

    <changeSet id="create stored columns for gateway_account_credentials credentials json fields" author="">
        <sql>
            ALTER TABLE gateway_account_credentials
                ADD COLUMN stripe_account_id TEXT GENERATED ALWAYS AS ((credentials :: jsonb)->> 'stripe_account_id') STORED,
                ADD COLUMN one_off_merchant_code TEXT GENERATED ALWAYS AS ((credentials :: jsonb)-> 'one_off_customer_initiated' ->> 'merchant_code') STORED,
                ADD COLUMN recurring_cit_merchant_code TEXT GENERATED ALWAYS AS ((credentials :: jsonb)-> 'recurring_customer_initiated' ->> 'merchant_code') STORED,
                ADD COLUMN recurring_mit_merchant_code TEXT GENERATED ALWAYS AS ((credentials :: jsonb)-> 'recurring_merchant_initiated' ->> 'merchant_code') STORED;
        </sql>
    </changeSet>

    <changeSet id="create indexes on gateway_account_credentials stored fields" runInTransaction="false" author="">
        <sql>
            CREATE INDEX CONCURRENTLY idx_stripe_account_id ON gateway_account_credentials (stripe_account_id);
            CREATE INDEX CONCURRENTLY idx_one_off_merchant_code ON gateway_account_credentials (one_off_merchant_code);
            CREATE INDEX CONCURRENTLY idx_recurring_cit_merchant_code ON gateway_account_credentials (recurring_cit_merchant_code);
            CREATE INDEX CONCURRENTLY idx_recurring_mit_merchant_code ON gateway_account_credentials (recurring_mit_merchant_code);
        </sql>
    </changeSet>

    <changeSet id="add agreement_payment_type to charges table" author="">
        <addColumn tableName="charges">
            <column name="agreement_payment_type" type="varchar(30)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

</databaseChangeLog>
