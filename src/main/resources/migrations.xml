<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="build gateway table" author="">
        <createTable tableName="gateway_accounts">
            <column name="gateway_account_id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="payment_provider" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="build tokens table" author="">
        <createTable tableName="tokens">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charge_id" type="bigserial">
                <constraints nullable="false"/>
            </column>
            <column name="secure_redirect_token" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="build charge table" author="">
        <createTable tableName="charges">
            <column name="charge_id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="amount" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="gateway_transaction_id" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="return_url" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="gateway_account_id" type="bigserial">
                <constraints foreignKeyName="fk__charges_gateway_accounts" referencedTableName="gateway_accounts"
                             referencedColumnNames="gateway_account_id" nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add description to charges table" author="">
        <addColumn tableName="charges">
            <column name="description" type="varchar(255)" defaultValue="">
                <constraints nullable="false" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add payment reference to charges table" author="">
        <addColumn tableName="charges">
            <column name="reference" type="varchar(255)" defaultValue="">
                <constraints nullable="false" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add credentials column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="credentials" type="json" defaultValue="{}">
                <constraints nullable="false" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="build charge_events table" author="">
        <createTable tableName="charge_events">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charge_id" type="bigserial">
                <constraints foreignKeyName="fk__charges_events" referencedTableName="charges"
                             referencedColumnNames="charge_id" nullable="false"/>
            </column>
            <column name="status" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="timestamp without timezone" defaultValueComputed="(now() at time zone 'utc')">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add created date to charges table" author="">
        <addColumn tableName="charges">
            <column name="created_date" type="timestamp without timezone"
                    defaultValueComputed="(now() at time zone 'utc')">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename 'gateway_accounts' primary key column" author="">
        <renameColumn columnDataType="bigserial"
                      oldColumnName="gateway_account_id"
                      newColumnName="id"
                      tableName="gateway_accounts"/>
    </changeSet>

    <changeSet id="rename 'charges' primary key column" author="">
        <renameColumn columnDataType="bigserial"
                      oldColumnName="charge_id"
                      newColumnName="id"
                      tableName="charges"/>
    </changeSet>

    <changeSet id="add version to charges table" author="">
        <addColumn tableName="charges">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add version to charge_events table" author="">
        <addColumn tableName="charge_events">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add version to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add version to tokens table" author="">
        <addColumn tableName="tokens">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add randomized external id to charges table" author="">
        <addColumn tableName="charges">
            <column name="external_id" type="char(26)">
                <constraints nullable="true" unique="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="migrate existing id data" author="">
        <sql>
            UPDATE charges SET external_id = id;
        </sql>
    </changeSet>

    <changeSet id="add NotNullConstraint to charges.external_id" author="">
        <addNotNullConstraint columnName="external_id"
                              tableName="charges"/>
    </changeSet>

    <changeSet id="createIndex charges.external_id" author="">
        <createIndex indexName="idx_charges_external_id"
                     tableName="charges"
                     unique="true">
            <column name="external_id" type="char(26)"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex charges.reference" author="">
        <createIndex indexName="idx_charges_reference"
                     tableName="charges"
                     unique="false">
            <column name="reference"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex charges.created_date" author="">
        <createIndex indexName="idx_charges_created_date"
                     tableName="charges"
                     unique="false">
            <column name="created_date"/>
        </createIndex>
    </changeSet>

    <changeSet id="add service_name column to charges table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="service_name" type="varchar(50)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="migrate legacy states in charges, events table" author="">
        <sql>
            UPDATE charges SET status = 'EXPIRE CANCEL READY' WHERE status = 'EXPIRE CANCEL PENDING';
        </sql>
        <sql>
            UPDATE charge_events SET status = 'EXPIRE CANCEL READY' WHERE status = 'EXPIRE CANCEL PENDING';
        </sql>
        <sql>
            UPDATE charges SET status = 'SYSTEM CANCEL READY' WHERE status = 'CANCEL READY';
        </sql>
        <sql>
            UPDATE charge_events SET status = 'SYSTEM CANCEL READY' WHERE status = 'CANCEL READY';
        </sql>
        <sql>
            UPDATE charges SET status = 'SYSTEM CANCEL ERROR' WHERE status = 'CANCEL ERROR';
        </sql>
        <sql>
            UPDATE charge_events SET status = 'SYSTEM CANCEL ERROR' WHERE status = 'CANCEL ERROR';
        </sql>
    </changeSet>


    <changeSet id="build card_types table" author="">
        <createTable tableName="card_types">
            <column name="id" type="uuid" defaultValueComputed="(uuid_generate_v4())">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="brand" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="varchar(15)">
                <constraints nullable="false"/>
            </column>
            <column name="label" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="build accepted_card_types table" author="">
        <createTable tableName="accepted_card_types">
            <column name="gateway_account_id" type="bigint">
                <constraints primaryKey="true"
                             foreignKeyName="fk__accepted_card_types_gateway_accounts"
                             referencedTableName="gateway_accounts"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="card_type_id" type="uuid">
                <constraints primaryKey="true"
                             foreignKeyName="fk__accepted_card_types_card_type" referencedTableName="card_types"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add email column to charges table" author="">
        <addColumn tableName="charges">
            <column name="email" type="varchar(50)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="Seed database table card_types" author="">
        <loadData file="seed-data/card_types.csv"
                  tableName="card_types">
        </loadData>
    </changeSet>

    <changeSet id="update email column in charges table to 254 chars" author="">
        <modifyDataType columnName="email"
                        newDataType="varchar(254)"
                        tableName="charges"/>
    </changeSet>

    <changeSet id="build email notifications table" author="">
        <createTable tableName="email_notifications">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account_id" type="bigserial">
                <constraints nullable="false"
                             foreignKeyName="fk__email_notifications_gateway_accounts"
                             referencedTableName="gateway_accounts"
                             referencedColumnNames="id"/>
            </column>
            <column name="template_body" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="" id="drop not null constraint on email notifications table">
        <dropNotNullConstraint columnDataType="text"
                               columnName="template_body"
                               tableName="email_notifications"/>
    </changeSet>

    <changeSet id="add enabled column to email notifications table" author="">
        <addColumn tableName="email_notifications">
            <column name="enabled" type="boolean" defaultValue="true" />
        </addColumn>
    </changeSet>

    <changeSet id="build refunds table" author="">
        <createTable tableName="refunds">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="external_id" type="char(26)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="amount" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(25)">
                <constraints nullable="false"/>
            </column>
            <column name="charge_id" type="bigserial">
                <constraints foreignKeyName="fk__refunds_charges" referencedTableName="charges"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="created_date" type="timestamp without timezone"
                    defaultValueComputed="(now() at time zone 'utc')">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="idx_refunds_external_id"
                     tableName="refunds"
                     unique="true">
            <column name="external_id" type="char(26)"/>
        </createIndex>
    </changeSet>

    <changeSet id="add type(TEST/LIVE) column to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="type" type="varchar(10)" defaultValue="TEST" remarks="possible values (TEST/LIVE)">
                <constraints nullable="false" unique="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="build confirmation_details table" author="">
        <createTable tableName="confirmation_details">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charge_id" type="bigserial">
                <constraints foreignKeyName="fk__confirmation_details_charges" unique="true" referencedTableName="charges"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="last_digits_card_number" type="char(4)">
                <constraints nullable="false"/>
            </column>
            <column name="cardholder_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="expiry_date" type="varchar(6)">
                <constraints nullable="false"/>
            </column>
            <column name="address_line1" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address_line2" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_postcode" type="varchar(25)">
                <constraints nullable="false"/>
            </column>
            <column name="address_city" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address_county" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_country" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="build notification_credentials table" author="">
        <createTable tableName="notification_credentials">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account_id" type="bigint">
                <constraints foreignKeyName="fk__notification_credentials_gateway_accounts"
                             referencedTableName="gateway_accounts"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="username" type="varchar(25)">
                <constraints nullable="false"/>
            </column>
            <column name="password" type="varchar(25)">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add card_brand columns to charges table" author="">
        <addColumn tableName="charges">
            <column name="card_brand" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="update password lenghth to 100 characters" author="">
        <modifyDataType columnName="password"
                        newDataType="varchar(100)"
                        tableName="notification_credentials"/>
    </changeSet>

    <changeSet id="add analytics_id and description to gateway_accounts table" author="">
        <addColumn tableName="gateway_accounts">
            <column name="description" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="analytics_id" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add card details columns to charges table" author="">
        <addColumn tableName="charges">
            <column name="last_digits_card_number" type="char(4)">
                <constraints nullable="true"/>
            </column>
            <column name="cardholder_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="expiry_date" type="varchar(6)">
                <constraints nullable="true"/>
            </column>
            <column name="address_line1" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_line2" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_postcode" type="varchar(25)">
                <constraints nullable="true"/>
            </column>
            <column name="address_city" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_county" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_country" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add reference column to refunds table" author="">
        <addColumn tableName="refunds">
            <column name="reference" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="migrate existing refund external ids" author="">
        <sql>
            UPDATE refunds SET reference = external_id;
        </sql>
    </changeSet>

    <changeSet id="add gateway transaction id column to charge_events table" author="">
        <addColumn tableName="charge_events">
            <column name="gateway_transaction_id" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="" id="dropTable-confirmation-details-table">
        <dropTable cascadeConstraints="true"
                   tableName="confirmation_details"/>
    </changeSet>

    <changeSet id="add gateway event date time column to charge_events table" author="">
        <addColumn tableName="charge_events">
            <column name="gateway_event_date" type="timestamp without timezone">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="createIndex charge_events.charge_id" author="">
        <createIndex indexName="idx_charge_events_charge_id"
                     tableName="charge_events"
                     unique="false">
            <column name="charge_id" type="bigserial"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex refunds.charge_id" author="">
        <createIndex indexName="idx_refunds_charge_id"
                     tableName="refunds"
                     unique="false">
            <column name="charge_id" type="bigserial"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex card_types.brand" author="">
        <createIndex indexName="idx_card_types_brand"
                     tableName="card_types"
                     unique="false">
            <column name="brand" type="text"/>
        </createIndex>
    </changeSet>

    <changeSet id="add flag for 3ds feature toggle on gateway account" author="">
        <addColumn tableName="gateway_accounts">
            <column name="requires_3ds" type="boolean" defaultValue="false"/>
        </addColumn>
    </changeSet>

    <changeSet id="add 3ds details to charge table" author="">
        <addColumn tableName="charges">
            <column name="pa_request_3ds" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="issuer_url_3ds" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add provider session id to charge table" author="">
        <addColumn tableName="charges">
            <column name="provider_session_id" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="createIndex charges.status" author="">
        <createIndex indexName="idx_charges_status"
                     tableName="charges"
                     unique="false">
            <column name="status" type="text"/>
        </createIndex>
    </changeSet>

    <changeSet id="add requires_3ds to card_types table" author="">
        <addColumn tableName="card_types">
            <column name="requires_3ds" type="boolean" defaultValue="false"/>
        </addColumn>
    </changeSet>

    <changeSet author="" id="insert maestro card type">
        <insert tableName="card_types">
            <column name="brand" value="maestro"/>
            <column name="type" value="DEBIT"/>
            <column name="label" value="Maestro"/>
            <column name="requires_3ds" value="true"/>
        </insert>
    </changeSet>

    <changeSet id="createIndex refunds.reference" author="">
        <createIndex indexName="idx_refunds_reference"
                     tableName="refunds"
                     unique="false">
            <column name="reference" type="text"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex gateway_accounts.payment_provider" author="">
        <createIndex indexName="idx_gateway_accounts_payment_provider"
                     tableName="gateway_accounts"
                     unique="false">
            <column name="payment_provider" type="varchar(255)"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex charges.gateway_account_id" author="">
        <createIndex indexName="idx_charges_gateway_account_id"
                     tableName="charges"
                     unique="false">
            <column name="gateway_account_id" type="bigserial"/>
        </createIndex>
    </changeSet>

    <changeSet id="createIndex refunds.created_date" author="">
        <createIndex indexName="idx_refunds_created_date"
                     tableName="refunds"
                     unique="false">
            <column name="created_date" />
        </createIndex>
    </changeSet>

    <changeSet id="build refunds_history table" author="">
        <createTable tableName="refunds_history">
            <column name="id" type="bigserial"/>
            <column name="external_id" type="char(26)" />
            <column name="amount" type="bigint" />
            <column name="status" type="varchar(25)" />
            <column name="charge_id" type="bigserial" />
            <column name="created_date" type="timestamp without timezone" />
            <column name="version" type="bigint" defaultValue="0" />
            <column name="reference" type="text"/>
            <column name="history_start_date" type="timestamp without timezone" />
            <column name="history_end_date" type="timestamp without timezone" />
        </createTable>
    </changeSet>

    <changeSet id="createIndex refunds_history.charge_id" author="">
        <createIndex indexName="idx_refunds_history_charge_id"
                     tableName="refunds_history"
                     unique="false">
            <column name="charge_id" type="bigserial"/>
        </createIndex>
    </changeSet>

    <changeSet id="add user_external_id column to refunds table" author="">
        <addColumn tableName="refunds">
            <column name="user_external_id" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add user_external_id column to refunds_history table" author="">
        <addColumn tableName="refunds_history">
            <column name="user_external_id" type="text">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="build payment_requests table" author="">
        <createTable tableName="payment_requests">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="amount" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="gateway_account_id" type="bigserial">
                <constraints foreignKeyName="fk__payment_requests_gateway_accounts"
                             referencedTableName="gateway_accounts"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="return_url" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(255)" defaultValue="">
                <constraints nullable="false" unique="false"/>
            </column>
            <column name="reference" type="varchar(255)" defaultValue="">
                <constraints nullable="false" unique="false"/>
            </column>
            <column name="created_date" type="timestamp without timezone"
                    defaultValueComputed="(now() at time zone 'utc')">
                <constraints nullable="false"/>
            </column>
            <column name="external_id" type="char(26)">
                <constraints nullable="true" unique="true"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add NotNullConstraint to payment_requests.external_id" author="">
        <addNotNullConstraint columnName="external_id"
                              tableName="payment_requests"/>
    </changeSet>

    <changeSet id="create table cards" author="">
        <createTable tableName="cards">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charge_id" type="bigserial">
                <constraints foreignKeyName="fk__cards_charges"
                             referencedTableName="charges"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="card_brand" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="last_digits_card_number" type="char(4)">
                <constraints nullable="false"/>
            </column>
            <column name="cardholder_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="expiry_date" type="varchar(6)">
                <constraints nullable="false"/>
            </column>
            <column name="address_line1" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address_line2" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_postcode" type="varchar(25)">
                <constraints nullable="false"/>
            </column>
            <column name="address_city" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address_county" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="address_country" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create table card_3ds" author="">
        <createTable tableName="card_3ds">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charge_id" type="bigserial">
                <constraints foreignKeyName="fk__card_3ds_charges"
                             referencedTableName="charges"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="pa_request" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="issuer_url" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="worldpay_machine_cookie" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="update email column in cards table to 254 chars" author="">
        <modifyDataType columnName="email"
                        newDataType="varchar(254)"
                        tableName="cards"/>
    </changeSet>

    <changeSet id="make email coumn in cards nullable" author="">
        <dropNotNullConstraint tableName="cards" columnName="email"/>
    </changeSet>

    <changeSet id="drop email from cards table" author="">
        <dropColumn tableName="cards" columnName="email"/>
    </changeSet>

    <changeSet id="createIndex cards.charge_id" author="">
        <createIndex indexName="idx_cards_charge_id"
                     tableName="cards"
                     unique="true">
            <column name="charge_id" type="bigserial"/>
        </createIndex>
    </changeSet>

    <changeSet id="remove not nullable columns from cards" author="">
        <modifyDataType tableName="cards" columnName="charge_id" newDataType="bigint"/>
        <dropNotNullConstraint tableName="cards" columnName="cardholder_name"/>
        <dropNotNullConstraint tableName="cards" columnName="last_digits_card_number"/>
        <dropNotNullConstraint tableName="cards" columnName="expiry_date"/>
        <dropNotNullConstraint tableName="cards" columnName="address_line1"/>
        <dropNotNullConstraint tableName="cards" columnName="address_postcode"/>
        <dropNotNullConstraint tableName="cards" columnName="address_city"/>
        <dropNotNullConstraint tableName="cards" columnName="address_country"/>
    </changeSet>

    <changeSet id="backfill cards with data from charges" author="">
        <sql>
            INSERT INTO cards (
            cardholder_name,
            card_brand,
            last_digits_card_number,
            expiry_date,
            address_line1,
            address_line2,
            address_postcode,
            address_city,
            address_county,
            address_country,
            charge_id
            )
            SELECT
            ch.cardholder_name,
            ch.card_brand,
            ch.last_digits_card_number,
            ch.expiry_date,
            ch.address_line1,
            ch.address_line2,
            ch.address_postcode,
            ch.address_city,
            ch.address_county,
            ch.address_country,
            ch.id
            FROM charges ch
            LEFT JOIN cards c ON c.charge_id = ch.id
            WHERE c.charge_id IS NULL
            AND (
            ch.cardholder_name IS NOT NULL OR
            ch.card_brand IS NOT NULL OR
            ch.last_digits_card_number IS NOT NULL OR
            ch.expiry_date IS NOT NULL OR
            ch.address_line1 IS NOT NULL OR
            ch.address_postcode IS NOT NULL OR
            ch.address_city IS NOT NULL OR
            ch.address_country IS NOT NULL
            );
        </sql>
    </changeSet>

    <changeSet id="change payment_requests gateway_account_id to bigint" author="">
        <modifyDataType tableName="payment_requests" columnName="gateway_account_id" newDataType="bigint"/>
    </changeSet>

    <changeSet id="createIndex payment_requests.external_id" author="">
        <createIndex indexName="idx_payment_requests_external_id"
                     tableName="payment_requests"
                     unique="true">
            <column name="external_id" type="char(26)"/>
        </createIndex>
    </changeSet>

    <changeSet id="change card_3ds.charge_id to bigint" author="">
        <modifyDataType tableName="card_3ds"
                        columnName="charge_id"
                        newDataType="bigint"/>
    </changeSet>

    <changeSet id="create unique index card_3ds.charge_id" author="">
        <createIndex tableName="card_3ds"
                     indexName="idx_card_3ds_charge_id"
                     unique="true">
            <column name="charge_id" type="bigint"/>
        </createIndex>
    </changeSet>

    <changeSet id="create table transactions" author="">
        <createTable tableName="transactions">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="payment_request_id" type="bigint">
                <constraints foreignKeyName="fk__payment_requests_id"
                             referencedTableName="payment_requests"
                             referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="gateway_transaction_id" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="amount" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="refund_external_id" type="char(26)">
                <constraints nullable="true"/>
            </column>
            <column name="status" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="user_external_id" type="varchar(32)">
                <constraints nullable="true"/>
            </column>
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="operation" type="text">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="backfill payment_requests from charges up to id 10000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 0 and ch.id < 10000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 20000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 10000 and ch.id < 20000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 30000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 20000 and ch.id < 30000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 40000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 30000 and ch.id < 40000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 50000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 40000 and ch.id < 50000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 60000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 50000 and ch.id < 60000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 70000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 60000 and ch.id < 70000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 80000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 70000 and ch.id < 80000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 90000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 80000 and ch.id < 90000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 100000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 90000 and ch.id < 100000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 110000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 100000 and ch.id < 110000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 120000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 110000 and ch.id < 120000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 130000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 120000 and ch.id < 130000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 140000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 130000 and ch.id < 140000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 150000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 140000 and ch.id < 150000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 160000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 150000 and ch.id < 160000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 170000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 160000 and ch.id < 170000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 180000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 170000 and ch.id < 180000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 190000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 180000 and ch.id < 190000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 200000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 190000 and ch.id < 200000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 210000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 200000 and ch.id < 210000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 220000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 210000 and ch.id < 220000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 230000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 220000 and ch.id < 230000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 240000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 230000 and ch.id < 240000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 250000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 240000 and ch.id < 250000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 260000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 250000 and ch.id < 260000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 270000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 260000 and ch.id < 270000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 280000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 270000 and ch.id < 280000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 290000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 280000 and ch.id < 290000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 300000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 290000 and ch.id < 300000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 310000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 300000 and ch.id < 310000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 320000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 310000 and ch.id < 320000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 330000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 320000 and ch.id < 330000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 340000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 330000 and ch.id < 340000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 350000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 340000 and ch.id < 350000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 360000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 350000 and ch.id < 360000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 370000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 360000 and ch.id < 370000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 380000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 370000 and ch.id < 380000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 390000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 380000 and ch.id < 390000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 400000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 390000 and ch.id < 400000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 410000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 400000 and ch.id < 410000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 420000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 410000 and ch.id < 420000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 430000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 420000 and ch.id < 430000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 440000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 430000 and ch.id < 440000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 450000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 440000 and ch.id < 450000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 460000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 450000 and ch.id < 460000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 470000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 460000 and ch.id < 470000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 480000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 470000 and ch.id < 480000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 490000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 480000 and ch.id < 490000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 500000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 490000 and ch.id < 500000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 510000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 500000 and ch.id < 510000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 520000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 510000 and ch.id < 520000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 530000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 520000 and ch.id < 530000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 540000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 530000 and ch.id < 540000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 550000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 540000 and ch.id < 550000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 560000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 550000 and ch.id < 560000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 570000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 560000 and ch.id < 570000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 580000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 570000 and ch.id < 580000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 590000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 580000 and ch.id < 590000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 600000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 590000 and ch.id < 600000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 610000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 600000 and ch.id < 610000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 620000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 610000 and ch.id < 620000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 630000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 620000 and ch.id < 630000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 640000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 630000 and ch.id < 640000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 650000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 640000 and ch.id < 650000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 660000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 650000 and ch.id < 660000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 670000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 660000 and ch.id < 670000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 680000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 670000 and ch.id < 680000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 690000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 680000 and ch.id < 690000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 700000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 690000 and ch.id < 700000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 710000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 700000 and ch.id < 710000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 720000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 710000 and ch.id < 720000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 730000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 720000 and ch.id < 730000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 740000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 730000 and ch.id < 740000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 750000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 740000 and ch.id < 750000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 760000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 750000 and ch.id < 760000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 770000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 760000 and ch.id < 770000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 780000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 770000 and ch.id < 780000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 790000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 780000 and ch.id < 790000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 800000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 790000 and ch.id < 800000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 810000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 800000 and ch.id < 810000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 820000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 810000 and ch.id < 820000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 830000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 820000 and ch.id < 830000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 840000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 830000 and ch.id < 840000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 850000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 840000 and ch.id < 850000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 860000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 850000 and ch.id < 860000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 870000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 860000 and ch.id < 870000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 880000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 870000 and ch.id < 880000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 890000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 880000 and ch.id < 890000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 900000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 890000 and ch.id < 900000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 910000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 900000 and ch.id < 910000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 920000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 910000 and ch.id < 920000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 930000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 920000 and ch.id < 930000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 940000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 930000 and ch.id < 940000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 950000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 940000 and ch.id < 950000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 960000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 950000 and ch.id < 960000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 970000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 960000 and ch.id < 970000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 980000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 970000 and ch.id < 980000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 990000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 980000 and ch.id < 990000;
            ]]>
        </sql>
    </changeSet>
    <changeSet id="backfill payment_requests from charges up to id 1000000" author="">
        <sql>
            <![CDATA[
              INSERT INTO payment_requests (
                  amount,return_url,gateway_account_id,description,reference,created_date,external_id
              )
              SELECT ch.amount,ch.return_url,ch.gateway_account_id,ch.description,ch.reference,ch.created_date,ch.external_id
              FROM charges ch
              LEFT JOIN payment_requests p ON p.external_id = ch.external_id
              WHERE p.external_id IS NULL and ch.id > 990000 and ch.id < 1000000;
            ]]>
        </sql>
    </changeSet>


</databaseChangeLog>
